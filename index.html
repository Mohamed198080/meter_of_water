<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تسجيل عداد</title>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
    input, button { margin: 10px; padding: 8px; }
    #scanner { width: 100%; max-width: 600px; margin: 20px auto; }
    #result { margin-top: 10px; color: green; font-weight: bold; }
  </style>
</head>
<body>

<h2>تسجيل بيانات العداد</h2>

<input type="text" id="counterNumber" placeholder="أدخل رقم العداد" required>
<button onclick="scanBarcode()">مسح الباركود</button>
<button onclick="submitData()">إدخال البيانات</button>
<div id="result"></div>

<div id="scanner" style="display:none;">
  <video id="video" autoplay playsinline></video>
</div>

<script>
  let scanning = false;

  function scanBarcode() {
    if (scanning) return;
    scanning = true;
    document.getElementById('scanner').style.display = 'block';

    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#video'),
        constraints: {
          facingMode: "environment"
        },
      },
      decoder: {
        readers: ["code_128_reader"]
      },
    }, function(err) {
      if (err) {
        console.error(err);
        alert("خطأ في تهيئة الكاميرا");
        scanning = false;
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(function(result) {
      const code = result.codeResult.code;
      document.getElementById('counterNumber').value = code;
      Quagga.stop();
      document.getElementById('scanner').style.display = 'none';
      scanning = false;
      document.getElementById('result').innerText = "تم مسح الباركود: " + code;
    });
  }

  function submitData() {
    const counterNumber = document.getElementById('counterNumber').value.trim();
    if (!counterNumber) {
      alert("يرجى إدخال رقم العداد");
      return;
    }

    // هنا يمكنك إضافة حقول أخرى حسب الحاجة
    const data = {
      counter_number: counterNumber,
      counter_type: "نوع العداد", // يمكنك إضافة حقول اختيارية
      brand: "ماركة العداد",
      sensor_type: "نوع المجس",
      sensor_status: "حالة المجس",
      box_status: "حالة الصندوق",
      part_number: "رقم القطعة",
      property_type: "نوع العقار",
      property_status: "حالة العقار",
      has_violation: "false",
      district: "اسم الحي",
      nearby_meters: "0",
      latitude: "0",
      longitude: "0",
      image_counter: "https://example.com/image1.jpg", // رابط الصورة
      image_part: "https://example.com/image2.jpg",
      image_property: "https://example.com/image3.jpg",
      image_box: "https://example.com/image4.jpg",
      image_violation: "https://example.com/image5.jpg",
      technician_name: "اسم الفني"
    };

    fetch("https://script.google.com/macros/s/AKfycbxcCArgLSfQ5qGTryNRaHxM4YJL6J-lEk9IF8owOex4Tr3VA60usd276ellJ0akw_FkIA/exec", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(data)
    })
    .then(res => res.json())
    .then(json => {
      if (json.success) {
        document.getElementById('result').innerText = "✅ تم إرسال البيانات بنجاح!";
        document.getElementById('counterNumber').value = "";
      } else {
        document.getElementById('result').innerText = "❌ خطأ: " + json.message;
      }
    })
    .catch(err => {
      document.getElementById('result').innerText = "❌ خطأ في الإرسال";
      console.error(err);
    });
  }
</script>

</body>
</html>
